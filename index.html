/* ======================================================
   ESTADO √öNICO DO APLICATIVO
   (NUNCA duplicar isso)
====================================================== */
const state = {
  products: [],      // todos os produtos (card√°pio completo)
  cart: [],          // itens no carrinho
  offers: {},        // ofertas ativas { productId: {price, start, end} }
  adminPrices: {},   // pre√ßos alterados pelo admin { productId: price }
  sales: [],         // hist√≥rico de vendas
  ui: {
    currentTab: null,
    isOpen: true
  }
};

/* ======================================================
   CONFIGURA√á√ïES GERAIS
====================================================== */
const CONFIG = {
  adminPassword: "1234",
  taxaEntrega: 8,
  horario: {
    fechadoDia: 1,        // segunda-feira
    abre: 18.5,           // 18:30
    fecha: 22.5           // 22:30
  }
};

/* ======================================================
   FUN√á√ÉO DE HOR√ÅRIO (ISOLADA)
====================================================== */
function checkIsOpen(date = new Date()) {
  const day = date.getDay();
  const hour = date.getHours() + date.getMinutes() / 60;

  if (day === CONFIG.horario.fechadoDia) return false;
  if (hour < CONFIG.horario.abre || hour > CONFIG.horario.fecha) return false;
  return true;
}

/* ======================================================
   MODELO DE PRODUTO
====================================================== */
/*
Produto = {
  id: string,
  name: string,
  category: string,
  price: number,
  active: boolean
}
*/

/* ======================================================
   CARRINHO ‚Äî FUN√á√ïES PURAS
====================================================== */
function addToCart(productId) {
  const product = state.products.find(p => p.id === productId && p.active);
  if (!product) return false;

  state.cart.push({
    id: product.id,
    name: product.name,
    price: getFinalPrice(product),
    category: product.category
  });
  return true;
}

function removeFromCart(index) {
  if (index < 0 || index >= state.cart.length) return;
  state.cart.splice(index, 1);
}

function clearCart() {
  state.cart = [];
}

function calculateTotal(isDelivery = false) {
  let total = 0;
  state.cart.forEach(i => total += i.price);
  if (isDelivery) total += CONFIG.taxaEntrega;
  return total;
}

/* ======================================================
   PRE√áOS E OFERTAS
====================================================== */
function getFinalPrice(product) {
  const adminPrice = state.adminPrices[product.id];
  const offer = state.offers[product.id];

  if (offer) {
    const today = new Date().toISOString().split("T")[0];
    if (today >= offer.start && today <= offer.end) {
      return offer.price;
    }
  }

  return adminPrice ?? product.price;
}

/* ======================================================
   BUSCA GLOBAL (SEM DOM)
====================================================== */
function searchProducts(query) {
  const q = query.toLowerCase();
  return state.products.filter(
    p => p.active && p.name.toLowerCase().includes(q)
  );
}

/* ======================================================
   ADMIN ‚Äî CONTROLE
====================================================== */
function adminLogin(password) {
  return password === CONFIG.adminPassword;
}

function setAdminPrice(productId, newPrice) {
  state.adminPrices[productId] = Number(newPrice);
}

function setOffer(productId, price, start, end) {
  state.offers[productId] = {
    price: Number(price),
    start,
    end
  };
}

function removeOffer(productId) {
  delete state.offers[productId];
}

function toggleProductActive(productId) {
  const product = state.products.find(p => p.id === productId);
  if (product) product.active = !product.active;
}

/* ======================================================
   VENDAS / RELAT√ìRIO
====================================================== */
function registerSale({ total, payment }) {
  state.sales.push({
    date: new Date().toISOString(),
    total,
    payment
  });
}

function getSalesReport() {
  let report = { total: 0, dinheiro: 0, pix: 0, cartao: 0 };

  state.sales.forEach(s => {
    report.total += s.total;
    if (s.payment === "Dinheiro") report.dinheiro += s.total;
    if (s.payment === "Pix") report.pix += s.total;
    if (s.payment.includes("Cart√£o")) report.cartao += s.total;
  });

  return report;
}
       /* ======================================================
   CARD√ÅPIO COMPLETO ‚Äî PRODUTOS BASE
====================================================== */
state.products = [

  /* ================= LANCHES ================= */
  { id:"L01", name:"X-Salada", category:"lanches", price:17, active:true },
  { id:"L02", name:"X-Burguer", category:"lanches", price:14, active:true },
  { id:"L03", name:"X-Frango", category:"lanches", price:22, active:true },
  { id:"L04", name:"X-Frango Cremoso", category:"lanches", price:20, active:true },
  { id:"L05", name:"X-Bacon", category:"lanches", price:25, active:true },
  { id:"L06", name:"X-Calabresa", category:"lanches", price:25, active:true },
  { id:"L07", name:"X-Cora√ß√£o", category:"lanches", price:27, active:true },
  { id:"L08", name:"X-Tudo", category:"lanches", price:32, active:true },
  { id:"L09", name:"X-Burguer Duplo", category:"lanches", price:22, active:true },
  { id:"L10", name:"X-Egg", category:"lanches", price:20, active:true },
  { id:"L11", name:"X-Tribom", category:"lanches", price:32, active:true },
  { id:"L12", name:"X-Da Casa", category:"lanches", price:45, active:true },
  { id:"L13", name:"X-Dog", category:"lanches", price:20, active:true },

  /* -------- ADICIONAIS LANCHES -------- */
  { id:"AL01", name:"Calabresa (Adicional)", category:"adicionais_lanches", price:7, active:true },
  { id:"AL02", name:"Bacon (Adicional)", category:"adicionais_lanches", price:7, active:true },
  { id:"AL03", name:"Cora√ß√£o (Adicional)", category:"adicionais_lanches", price:8, active:true },
  { id:"AL04", name:"Ovo (Adicional)", category:"adicionais_lanches", price:3, active:true },
  { id:"AL05", name:"Salsicha (Adicional)", category:"adicionais_lanches", price:4, active:true },
  { id:"AL06", name:"Frango (Adicional)", category:"adicionais_lanches", price:7, active:true },
  { id:"AL07", name:"Cheddar (Adicional)", category:"adicionais_lanches", price:4, active:true },
  { id:"AL08", name:"Hamb√∫rguer Artesanal (Adicional)", category:"adicionais_lanches", price:10, active:true },
  { id:"AL09", name:"Maionese Caseira (Adicional)", category:"adicionais_lanches", price:2, active:true },

  /* ================= POR√á√ïES ================= */
  { id:"P01", name:"Fritas", category:"porcoes", price:24.99, active:true },
  { id:"P02", name:"Fritas c/ Frango", category:"porcoes", price:39.99, active:true },
  { id:"P03", name:"Fritas c/ Calabresa", category:"porcoes", price:34.99, active:true },
  { id:"P04", name:"Fritas c/ Bacon", category:"porcoes", price:34.99, active:true },
  { id:"P05", name:"An√©is de Cebola", category:"porcoes", price:24.99, active:true },
  { id:"P06", name:"Fritas c/ Bacon, Calabresa e Queijo", category:"porcoes", price:39.99, active:true },
  { id:"P07", name:"Fritas c/ Bacon Cheddar", category:"porcoes", price:39.99, active:true },
  { id:"P08", name:"Fritas c/ Polenta e Frango", category:"porcoes", price:39.99, active:true },
  { id:"P09", name:"Fritas c/ Polenta", category:"porcoes", price:24.99, active:true },
  { id:"P10", name:"Fritas c/ Calabresa e Catupiry", category:"porcoes", price:35.99, active:true },
  { id:"P11", name:"Fritas, Polenta, Chuleta e Anel de Cebola", category:"porcoes", price:49.99, active:true },

  /* ================= PAST√âIS ================= */
  { id:"PA01", name:"Pastel de Carne", category:"pasteis", price:14, active:true },
  { id:"PA02", name:"Pastel de Frango", category:"pasteis", price:12, active:true },
  { id:"PA03", name:"Frango Bacon Cheddar", category:"pasteis", price:16, active:true },
  { id:"PA04", name:"Bacon Cheddar", category:"pasteis", price:15, active:true },
  { id:"PA05", name:"Calabresa c/ Cebola", category:"pasteis", price:14, active:true },
  { id:"PA06", name:"Carne e Queijo", category:"pasteis", price:15, active:true },
  { id:"PA07", name:"Queijo", category:"pasteis", price:14, active:true },
  { id:"PA08", name:"Chocolate ao Leite", category:"pasteis", price:15, active:true },
  { id:"PA09", name:"Banana Queijo Canela", category:"pasteis", price:15, active:true },
  { id:"PA10", name:"Romeu e Julieta", category:"pasteis", price:15, active:true },
  { id:"PA11", name:"Chocolate Branco", category:"pasteis", price:15, active:true },
  { id:"PA12", name:"Creme e Ouro Branco", category:"pasteis", price:15, active:true },
  { id:"PA13", name:"Creme e Sonho de Valsa", category:"pasteis", price:15, active:true },

  /* ================= A√áA√ç (TAMANHOS) ================= */
  { id:"A01", name:"A√ßa√≠ 300ml", category:"acai_tamanho", price:12, active:true },
  { id:"A02", name:"A√ßa√≠ 400ml", category:"acai_tamanho", price:15, active:true },
  { id:"A03", name:"A√ßa√≠ 500ml", category:"acai_tamanho", price:18, active:true },

  /* -------- ADICIONAIS A√áA√ç -------- */
  { id:"AA01", name:"Pa√ßoca", category:"acai_adicional", price:2, active:true },
  { id:"AA02", name:"Leite em p√≥", category:"acai_adicional", price:4, active:true },
  { id:"AA03", name:"Granola", category:"acai_adicional", price:4, active:true },
  { id:"AA04", name:"Morango", category:"acai_adicional", price:4, active:true },
  { id:"AA05", name:"M&M", category:"acai_adicional", price:3, active:true },
  { id:"AA06", name:"Ouro Branco", category:"acai_adicional", price:3, active:true },
  { id:"AA07", name:"Banana", category:"acai_adicional", price:2, active:true },
  { id:"AA08", name:"Sonho de Valsa", category:"acai_adicional", price:3, active:true },
  { id:"AA09", name:"Leite Condensado", category:"acai_adicional", price:3, active:true },
  { id:"AA10", name:"Nutella", category:"acai_adicional", price:4, active:true },

  /* ================= BEBIDAS ================= */
  { id:"B01", name:"Cassulinha 200ml", category:"bebidas", price:3, active:true },
  { id:"B02", name:"Coca-Cola 600ml", category:"bebidas", price:8, active:true },
  { id:"B03", name:"Coca-Cola 2L", category:"bebidas", price:16, active:true },
  { id:"B04", name:"Refri Lata", category:"bebidas", price:6, active:true },
  { id:"B05", name:"Refrigerante 2L", category:"bebidas", price:12, active:true },
  { id:"B06", name:"Cerveja Lata 350ml", category:"bebidas", price:6, active:true },
  { id:"B07", name:"Achocolatado 200ml", category:"bebidas", price:3, active:true }
];
<script>
/* ======================================================
   START DO APP
====================================================== */
function startApp(){
  document.getElementById("splash").style.display="none";
  document.getElementById("app").style.display="block";

  state.ui.isOpen = checkIsOpen();
  document.getElementById("closedMsg").style.display =
    state.ui.isOpen ? "none" : "block";

  state.ui.currentTab = null;
  document.getElementById("content").innerHTML =
    "<p>Escolha uma categoria acima</p>";
}

/* ======================================================
   ABAS (ABREM S√ì QUANDO CLICADAS)
====================================================== */
function openTab(category){
  state.ui.currentTab = category;
  renderCategory(category);
}

/* ======================================================
   RENDER DE CATEGORIA
====================================================== */
function renderCategory(category){
  const container = document.getElementById("content");
  container.innerHTML = "";

  let list = [];

  if(category === "acai"){
    list = state.products.filter(p =>
      p.category === "acai_tamanho" ||
      p.category === "acai_adicional"
    );
  }else{
    list = state.products.filter(p => p.category === category);
  }

  list
    .filter(p => p.active)
    .forEach(p=>{
      const price = getFinalPrice(p);

      const div = document.createElement("div");
      div.innerHTML = `
        <strong>${p.name}</strong><br>
        R$ ${price.toFixed(2).replace(".",",")}
        <button onclick="handleAdd('${p.id}')">+</button>
        <hr>
      `;
      container.appendChild(div);
    });
}

/* ======================================================
   BUSCA GLOBAL (FUNCIONA EM TODAS AS ABAS)
====================================================== */
function onSearch(text){
  const q = text.trim().toLowerCase();
  const container = document.getElementById("content");
  container.innerHTML = "";

  if(q === ""){
    if(state.ui.currentTab){
      renderCategory(state.ui.currentTab);
    }
    return;
  }

  const results = searchProducts(q);

  if(results.length === 0){
    container.innerHTML = "<p>Nenhum produto encontrado</p>";
    return;
  }

  results.forEach(p=>{
    const price = getFinalPrice(p);
    const div = document.createElement("div");
    div.innerHTML = `
      <strong>${p.name}</strong><br>
      R$ ${price.toFixed(2).replace(".",",")}
      <button onclick="handleAdd('${p.id}')">+</button>
      <hr>
    `;
    container.appendChild(div);
  });
}

/* ======================================================
   ADICIONAR AO CARRINHO
====================================================== */
function handleAdd(productId){
  if(!checkIsOpen()){
    alert("Estamos fechados no momento");
    return;
  }

  addToCart(productId);
  renderCart();
}

/* ======================================================
   RENDER DO CARRINHO
====================================================== */
function renderCart(){
  const cartBox = document.getElementById("cart");
  const itemsBox = document.getElementById("cartItems");
  const totalBox = document.getElementById("cartTotal");

  itemsBox.innerHTML = "";

  if(state.cart.length === 0){
    cartBox.style.display="none";
    return;
  }

  cartBox.style.display="block";

  state.cart.forEach((i,idx)=>{
    const div = document.createElement("div");
    div.innerHTML = `
      ${i.name} ‚Äî R$ ${i.price.toFixed(2).replace(".",",")}
      <button onclick="removeItem(${idx})">x</button>
    `;
    itemsBox.appendChild(div);
  });

  totalBox.innerHTML =
    "Total: R$ " +
    calculateTotal(false).toFixed(2).replace(".",",");
}

/* ======================================================
   REMOVER ITEM
====================================================== */
function removeItem(index){
  removeFromCart(index);
  renderCart();
}
</script>
<!-- FINALIZA√á√ÉO -->
<div id="checkout" style="display:none">
  <h3>Finalizar Pedido</h3>

  <input id="clientName" placeholder="Seu nome">

  <div>
    <label>
      <input type="radio" name="delivery" checked onclick="setDelivery(false)">
      Retirada
    </label>
    <label>
      <input type="radio" name="delivery" onclick="setDelivery(true)">
      Entrega (+ R$ 8)
    </label>
  </div>

  <input id="clientAddress" placeholder="Endere√ßo" style="display:none">

  <select id="paymentMethod">
    <option value="">Forma de pagamento</option>
    <option>Dinheiro</option>
    <option>Pix</option>
    <option>Cart√£o D√©bito</option>
    <option>Cart√£o Cr√©dito</option>
  </select>

  <button onclick="confirmOrder()">Confirmar Pedido</button>
</div>

<!-- ADMIN ‚Äî OFERTAS -->
<div id="adminOffers" style="display:none">
  <h3>Painel de Ofertas</h3>
  <div id="offerList"></div>
  <button onclick="closeAdmin()">Fechar</button>
</div>

<!-- ADMIN ‚Äî RELAT√ìRIO -->
<div id="adminReport" style="display:none">
  <h3>Relat√≥rio do Dia</h3>
  <pre id="reportText"></pre>
  <button onclick="closeAdmin()">Fechar</button>
</div>
<script>
/* ======================================================
   ENTREGA
====================================================== */
function setDelivery(value){
  state.delivery = value;
  document.getElementById("clientAddress").style.display =
    value ? "block" : "none";
}

/* ======================================================
   ABRIR CHECKOUT
====================================================== */
function openCheckout(){
  if(state.cart.length === 0){
    alert("Carrinho vazio");
    return;
  }

  const hasDrink = state.cart.some(i =>
    state.products.find(p => p.id === i.id)?.category === "bebidas"
  );

  if(!hasDrink){
    if(confirm("Vai querer bebida?")){
      openTab("bebidas");
      return;
    }
  }

  document.getElementById("checkout").style.display="block";
}

/* ======================================================
   CONFIRMAR PEDIDO
====================================================== */
function confirmOrder(){
  const name = document.getElementById("clientName").value;
  const address = document.getElementById("clientAddress").value;
  const payment = document.getElementById("paymentMethod").value;

  if(!name) return alert("Informe seu nome");
  if(state.delivery && !address) return alert("Informe o endere√ßo");
  if(!payment) return alert("Informe a forma de pagamento");

  sendWhatsApp(name,address,payment);
}
</script>
<script>
function sendWhatsApp(name,address,payment){
  let msg = "üçî *Pedido Rabika's Burguer*\n\n";
  let total = 0;

  state.cart.forEach(i=>{
    msg += `- ${i.name} R$ ${i.price.toFixed(2).replace(".",",")}\n`;
    total += i.price;
  });

  if(state.delivery){
    msg += "\nEntrega: R$ 8,00\n";
    total += state.freight;
    msg += "Endere√ßo: " + address + "\n";
  }else{
    msg += "\nRetirada no local\n";
  }

  msg += "\nPagamento: " + payment;
  msg += "\n\nTotal: R$ " + total.toFixed(2).replace(".",",");

  // salva venda
  state.sales.push({
    date: new Date().toISOString(),
    total,
    payment
  });
  saveStorage();

  window.open(
    "https://wa.me/554991789706?text=" +
    encodeURIComponent(msg)
  );
}
</script>
<script>
/* ======================================================
   ADMIN VIA BUSCA
====================================================== */
function adminCommand(text){
  if(text === "oferta"){
    askPassword(()=>openOffers());
  }
  if(text === "relatorio"){
    askPassword(()=>openReport());
  }
}

function askPassword(cb){
  const s = prompt("Senha do administrador:");
  if(s === "1234") cb();
  else alert("Senha incorreta");
}

/* ======================================================
   OFERTAS
====================================================== */
function openOffers(){
  const box = document.getElementById("offerList");
  box.innerHTML = "";

  state.products.forEach(p=>{
    if(!p.active) return;

    box.innerHTML += `
      <div>
        <strong>${p.name}</strong><br>
        <input type="number" placeholder="Pre√ßo oferta" id="ofp_${p.id}">
        <input type="date" id="ofi_${p.id}">
        <input type="date" id="off_${p.id}">
        <button onclick="saveOffer('${p.id}')">Salvar</button>
      </div><hr>
    `;
  });

  document.getElementById("adminOffers").style.display="block";
}

function saveOffer(id){
  const p = state.products.find(x=>x.id===id);
  p.offer = {
    price: Number(document.getElementById("ofp_"+id).value),
    start: document.getElementById("ofi_"+id).value,
    end: document.getElementById("off_"+id).value
  };
  saveStorage();
  renderCart();
  alert("Oferta salva");
}

/* ======================================================
   RELAT√ìRIO
====================================================== */
function openReport(){
  let today = new Date().toISOString().split("T")[0];
  let t=0,d=0,p=0,c=0;

  state.sales.forEach(s=>{
    if(s.date.startsWith(today)){
      t+=s.total;
      if(s.payment==="Dinheiro")d+=s.total;
      if(s.payment==="Pix")p+=s.total;
      if(s.payment.includes("Cart√£o"))c+=s.total;
    }
  });

  document.getElementById("reportText").innerText =
    `Total: R$ ${t.toFixed(2)}\nDinheiro: R$ ${d.toFixed(2)}\nPix: R$ ${p.toFixed(2)}\nCart√£o: R$ ${c.toFixed(2)}`;

  document.getElementById("adminReport").style.display="block";
}

function closeAdmin(){
  document.getElementById("adminOffers").style.display="none";
  document.getElementById("adminReport").style.display="none";
}
</script>

</body>
</html>


