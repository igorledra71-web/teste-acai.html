/* ======================================================
   ESTADO ÚNICO DO APLICATIVO
   (NUNCA duplicar isso)
====================================================== */
const state = {
  products: [],      // todos os produtos (cardápio completo)
  cart: [],          // itens no carrinho
  offers: {},        // ofertas ativas { productId: {price, start, end} }
  adminPrices: {},   // preços alterados pelo admin { productId: price }
  sales: [],         // histórico de vendas
  ui: {
    currentTab: null,
    isOpen: true
  }
};

/* ======================================================
   CONFIGURAÇÕES GERAIS
====================================================== */
const CONFIG = {
  adminPassword: "1234",
  taxaEntrega: 8,
  horario: {
    fechadoDia: 1,        // segunda-feira
    abre: 18.5,           // 18:30
    fecha: 22.5           // 22:30
  }
};

/* ======================================================
   FUNÇÃO DE HORÁRIO (ISOLADA)
====================================================== */
function checkIsOpen(date = new Date()) {
  const day = date.getDay();
  const hour = date.getHours() + date.getMinutes() / 60;

  if (day === CONFIG.horario.fechadoDia) return false;
  if (hour < CONFIG.horario.abre || hour > CONFIG.horario.fecha) return false;
  return true;
}

/* ======================================================
   MODELO DE PRODUTO
====================================================== */
/*
Produto = {
  id: string,
  name: string,
  category: string,
  price: number,
  active: boolean
}
*/

/* ======================================================
   CARRINHO — FUNÇÕES PURAS
====================================================== */
function addToCart(productId) {
  const product = state.products.find(p => p.id === productId && p.active);
  if (!product) return false;

  state.cart.push({
    id: product.id,
    name: product.name,
    price: getFinalPrice(product),
    category: product.category
  });
  return true;
}

function removeFromCart(index) {
  if (index < 0 || index >= state.cart.length) return;
  state.cart.splice(index, 1);
}

function clearCart() {
  state.cart = [];
}

function calculateTotal(isDelivery = false) {
  let total = 0;
  state.cart.forEach(i => total += i.price);
  if (isDelivery) total += CONFIG.taxaEntrega;
  return total;
}

/* ======================================================
   PREÇOS E OFERTAS
====================================================== */
function getFinalPrice(product) {
  const adminPrice = state.adminPrices[product.id];
  const offer = state.offers[product.id];

  if (offer) {
    const today = new Date().toISOString().split("T")[0];
    if (today >= offer.start && today <= offer.end) {
      return offer.price;
    }
  }

  return adminPrice ?? product.price;
}

/* ======================================================
   BUSCA GLOBAL (SEM DOM)
====================================================== */
function searchProducts(query) {
  const q = query.toLowerCase();
  return state.products.filter(
    p => p.active && p.name.toLowerCase().includes(q)
  );
}

/* ======================================================
   ADMIN — CONTROLE
====================================================== */
function adminLogin(password) {
  return password === CONFIG.adminPassword;
}

function setAdminPrice(productId, newPrice) {
  state.adminPrices[productId] = Number(newPrice);
}

function setOffer(productId, price, start, end) {
  state.offers[productId] = {
    price: Number(price),
    start,
    end
  };
}

function removeOffer(productId) {
  delete state.offers[productId];
}

function toggleProductActive(productId) {
  const product = state.products.find(p => p.id === productId);
  if (product) product.active = !product.active;
}

/* ======================================================
   VENDAS / RELATÓRIO
====================================================== */
function registerSale({ total, payment }) {
  state.sales.push({
    date: new Date().toISOString(),
    total,
    payment
  });
}

function getSalesReport() {
  let report = { total: 0, dinheiro: 0, pix: 0, cartao: 0 };

  state.sales.forEach(s => {
    report.total += s.total;
    if (s.payment === "Dinheiro") report.dinheiro += s.total;
    if (s.payment === "Pix") report.pix += s.total;
    if (s.payment.includes("Cartão")) report.cartao += s.total;
  });

  return report;
}
